name: Weekly Financials Update

on:
  # æ¯é€±æ—¥æ›œ JST 9:00 (UTC 0:00) ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * 0'

  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

jobs:
  update-financials:
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ============================================================

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests yfinance

      # ============================================================
      # Step 1: WordPressç™»éŒ²ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—
      # ============================================================

      - name: Fetch WordPress registered companies
        run: |
          echo "=========================================="
          echo "Step 1: WordPressç™»éŒ²ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—"
          echo "=========================================="
          python scripts/fetch_wordpress_companies.py

      - name: Check company list
        id: check-list
        run: |
          if [ -f "data/wordpress_companies.csv" ]; then
            echo "list_exists=true" >> $GITHUB_OUTPUT
            COMPANY_COUNT=$(wc -l < data/wordpress_companies.csv)
            echo "âœ… wordpress_companies.csv: $COMPANY_COUNT ç¤¾"
          else
            echo "list_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ wordpress_companies.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      # ============================================================
      # Step 2: è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—
      # ============================================================

      - name: Fetch financial data
        if: steps.check-list.outputs.list_exists == 'true'
        run: |
          echo "=========================================="
          echo "Step 2: è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹"
          echo "=========================================="
          python scripts/fetch_financials.py

      - name: Commit financial data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/financials/*.json || true
          git diff --staged --quiet || git commit -m "Update financial data $(date +'%Y-%m-%d')"
          git push || true

      # ============================================================
      # Step 3: WordPressæ›´æ–°
      # ============================================================

      - name: Update WordPress financials
        if: steps.check-list.outputs.list_exists == 'true'
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
        run: |
          echo "=========================================="
          echo "Step 3: WordPressè²¡å‹™ãƒ‡ãƒ¼ã‚¿æ›´æ–°"
          echo "=========================================="
          python scripts/update_financials.py

      # ============================================================
      # Artifactsä¿å­˜
      # ============================================================

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-financials-data
          path: |
            data/financials/*.json
            data/wordpress_companies.csv
          retention-days: 30
          if-no-files-found: warn

      # ============================================================
      # å®Ÿè¡Œã‚µãƒãƒªãƒ¼
      # ============================================================

      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š é€±æ¬¡è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚:** $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "data/financials" ]; then
            FILE_COUNT=$(ls -1 data/financials/*.json 2>/dev/null | wc -l)
            echo "âœ… **è²¡å‹™ãƒ‡ãƒ¼ã‚¿:** ${FILE_COUNT} ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **è²¡å‹™ãƒ‡ãƒ¼ã‚¿:** æ›´æ–°ãªã—" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**" >> $GITHUB_STEP_SUMMARY
          echo "1. WordPressç™»éŒ²ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—" >> $GITHUB_STEP_SUMMARY
          echo "2. yfinanceè²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ5å¹´åˆ†ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. WordPress yfinance_financials æ›´æ–°" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ é€±æ¬¡è²¡å‹™ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
