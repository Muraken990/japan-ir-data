name: Monthly Analyst & Earnings Update

on:
  # æ¯æœˆ1æ—¥ JST 9:00 (UTC 0:00) ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 1 * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      limit:
        description: 'å‡¦ç†ã™ã‚‹ä¼æ¥­æ•°ï¼ˆç©ºæ¬„ã§å…¨ä»¶ï¼‰'
        required: false
        default: ''
        type: string

jobs:
  update-analyst-earnings:
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ============================================================

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests yfinance lxml

      - name: Test earnings dates fetch (single company)
        run: |
          python3 -c "import yfinance as yf; ticker = yf.Ticker('6586.T'); print(ticker.get_earnings_dates(limit=4))"

      # ============================================================
      # Step 1: WordPressç™»éŒ²ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—
      # ============================================================

      - name: Fetch WordPress registered companies
        run: |
          echo "=========================================="
          echo "Step 1: WordPressç™»éŒ²ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—"
          echo "=========================================="
          python scripts/fetch_wordpress_companies.py

      - name: Check company list
        id: check-list
        run: |
          if [ -f "data/wordpress_companies.csv" ]; then
            echo "list_exists=true" >> $GITHUB_OUTPUT
            COMPANY_COUNT=$(wc -l < data/wordpress_companies.csv)
            echo "âœ… wordpress_companies.csv: $COMPANY_COUNT ç¤¾"
          else
            echo "list_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ wordpress_companies.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      # ============================================================
      # Step 2: ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿å–å¾—
      # ============================================================

      - name: Fetch analyst and earnings data
        if: steps.check-list.outputs.list_exists == 'true'
        run: |
          echo "=========================================="
          echo "Step 2: ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹"
          echo "=========================================="
          LIMIT_ARG=""
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            LIMIT_ARG="--limit ${{ github.event.inputs.limit }}"
            echo "åˆ¶é™: ${{ github.event.inputs.limit }}ç¤¾"
          fi
          python scripts/fetch_analyst_earnings.py $LIMIT_ARG

      - name: Commit analyst earnings data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/analyst_earnings/*.json || true
          git diff --staged --quiet || git commit -m "Update analyst & earnings data $(date +'%Y-%m-%d')"
          git push || true

      # ============================================================
      # Step 3: WordPressæ›´æ–°
      # ============================================================

      - name: Update WordPress analyst earnings
        if: steps.check-list.outputs.list_exists == 'true'
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
        run: |
          echo "=========================================="
          echo "Step 3: WordPressã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿æ›´æ–°"
          echo "=========================================="
          LIMIT_ARG=""
          if [ -n "${{ github.event.inputs.limit }}" ]; then
            LIMIT_ARG="--limit ${{ github.event.inputs.limit }}"
          fi
          python scripts/update_analyst_earnings.py $LIMIT_ARG

      # ============================================================
      # Artifactsä¿å­˜
      # ============================================================

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-analyst-earnings-data
          path: |
            data/analyst_earnings/*.json
            data/wordpress_companies.csv
          retention-days: 30
          if-no-files-found: warn

      # ============================================================
      # å®Ÿè¡Œã‚µãƒãƒªãƒ¼
      # ============================================================

      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š æœˆæ¬¡ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚:** $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "data/analyst_earnings" ]; then
            FILE_COUNT=$(ls -1 data/analyst_earnings/*.json 2>/dev/null | wc -l)
            echo "âœ… **ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿:** ${FILE_COUNT} ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿:** æ›´æ–°ãªã—" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**" >> $GITHUB_STEP_SUMMARY
          echo "1. WordPressç™»éŒ²ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—" >> $GITHUB_STEP_SUMMARY
          echo "2. yfinanceã‚¢ãƒŠãƒªã‚¹ãƒˆäºˆæƒ³ãƒ»æ±ºç®—æ—¥ç¨‹å–å¾—" >> $GITHUB_STEP_SUMMARY
          echo "3. WordPress analyst_earnings_data æ›´æ–°" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ æœˆæ¬¡ã‚¢ãƒŠãƒªã‚¹ãƒˆãƒ»æ±ºç®—ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
