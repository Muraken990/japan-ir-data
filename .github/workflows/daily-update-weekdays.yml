name: Daily Update - Weekdays (Mon-Fri)

on:
  # æœˆæ›œã€œé‡‘æ›œ JST 9:00 (UTC 0:00) ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * 1-5'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

jobs:
  daily-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests yfinance
      
      # ============================================================
      # Step 1: yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—
      # ============================================================
      
      - name: Download latest company list
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: workflow_name_here.yml  # TODO: ä¼æ¥­ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
          name: company-list
          path: data/
          if_no_artifact_found: warn
        continue-on-error: true
      
      - name: Check company list
        id: check-list
        run: |
          if [ -f "data/japan_companies_latest.csv" ]; then
            echo "list_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… japan_companies_latest.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            echo "ğŸ“Š ä¼æ¥­æ•°: $(wc -l < data/japan_companies_latest.csv)"
          else
            echo "list_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ japan_companies_latest.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
      
      - name: Fetch yfinance data
        if: steps.check-list.outputs.list_exists == 'true'
        run: |
          echo "=========================================="
          echo "Step 1: yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹"
          echo "=========================================="
          python scripts/yfinance_fetch_all_fields.py
      
      # ============================================================
      # Step 2: ãƒ‡ãƒ¼ã‚¿çµ±åˆ
      # ============================================================
      
      - name: Merge data
        if: steps.check-list.outputs.list_exists == 'true'
        run: |
          echo "=========================================="
          echo "Step 2: ãƒ‡ãƒ¼ã‚¿çµ±åˆé–‹å§‹"
          echo "=========================================="
          
          # æœ€æ–°ã®yfinance CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
          YFINANCE_CSV=$(ls -t output/yfinance_all_fields_*.csv 2>/dev/null | head -n1)
          
          if [ -z "$YFINANCE_CSV" ]; then
            echo "âŒ yfinanceãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "ğŸ“¥ ä½¿ç”¨ã™ã‚‹yfinanceãƒ•ã‚¡ã‚¤ãƒ«: $YFINANCE_CSV"
          
          # 3_merge_data.pyã‚’å®Ÿè¡Œ
          export YAHOO_JP_CSV=data/japan_companies_latest.csv
          export YFINANCE_CSV=$YFINANCE_CSV
          export OUTPUT_DIR=data
          
          python scripts/3_merge_data.py
      
      # ============================================================
      # Step 3: WordPressæ›´æ–° (æ—¢å­˜100ç¤¾ã®ã¿)
      # ============================================================
      
      - name: Check integrated CSV
        id: check-integrated
        run: |
          if [ -f "data/integrated_company_data.csv" ]; then
            echo "integrated_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… integrated_company_data.csv ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
            echo "ğŸ“Š ä¼æ¥­æ•°: $(wc -l < data/integrated_company_data.csv)"
          else
            echo "integrated_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ integrated_company_data.csv ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
      
      - name: Update WordPress (Existing 100 companies only)
        if: steps.check-integrated.outputs.integrated_exists == 'true'
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
          REQUEST_DELAY: '0.5'
        run: |
          echo "=========================================="
          echo "Step 3: WordPressæ›´æ–°é–‹å§‹ (æ—¢å­˜100ç¤¾ã®ã¿)"
          echo "=========================================="
          python scripts/4_wordpress_smart_update.py --update-only
      
      # ============================================================
      # Artifactsä¿å­˜
      # ============================================================
      
      - name: Upload integrated data
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integrated-data
          path: |
            data/integrated_company_data*.csv
            output/yfinance_all_fields_*.csv
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload execution logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: execution-logs
          path: |
            *.log
            output/*.log
          retention-days: 7
          if-no-files-found: ignore
      
      # ============================================================
      # é€šçŸ¥
      # ============================================================
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚:** $(date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/integrated_company_data.csv" ]; then
            COMPANY_COUNT=$(wc -l < data/integrated_company_data.csv)
            echo "âœ… **çµ±åˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ:** æˆåŠŸ ($COMPANY_COUNTç¤¾)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çµ±åˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ:** å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—:**" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… ãƒ‡ãƒ¼ã‚¿çµ±åˆ" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… WordPressæ›´æ–° (æ—¢å­˜100ç¤¾)" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
