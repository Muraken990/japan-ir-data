name: Update Existing 100 Companies (Mon-Fri)

on:
  # æœˆæ›œã€œé‡‘æ›œ JST 9:00 (UTC 0:00) ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * 1-5'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

jobs:
  update-existing-100:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests
      
      - name: Download latest integrated data
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: fetch_all_fields.yml
          name: all-fields-data
          path: output/
          if_no_artifact_found: warn
        continue-on-error: true
      
      - name: Find and prepare CSV
        id: prepare-csv
        run: |
          echo "=== CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦ã„ã¾ã™ ==="
          
          # output/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’è¡¨ç¤º
          ls -lh output/ 2>/dev/null || echo "output/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
          
          # integrated_company_data.csvã‚’æ¢ã™
          if [ -f "output/integrated_company_data.csv" ]; then
            CSV_PATH="output/integrated_company_data.csv"
          elif [ -f "data/integrated_company_data.csv" ]; then
            CSV_PATH="data/integrated_company_data.csv"
          else
            # yfinance_all_fields_*.csvã‹ã‚‰æœ€æ–°ã‚’æ¢ã™
            CSV_PATH=$(ls -t output/yfinance_all_fields_*.csv 2>/dev/null | head -n1)
          fi
          
          if [ -z "$CSV_PATH" ] || [ ! -f "$CSV_PATH" ]; then
            echo "csv_found=false" >> $GITHUB_OUTPUT
            echo "âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # data/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã‚³ãƒ”ãƒ¼
          mkdir -p data
          cp "$CSV_PATH" data/integrated_company_data.csv
          
          echo "csv_found=true" >> $GITHUB_OUTPUT
          echo "âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†: $CSV_PATH"
          echo "ğŸ“Š è¡Œæ•°: $(wc -l < data/integrated_company_data.csv)"
      
      - name: Update WordPress (Existing 100 companies only)
        if: steps.prepare-csv.outputs.csv_found == 'true'
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
          REQUEST_DELAY: '0.5'
        run: |
          echo "=========================================="
          echo "æ—¢å­˜100ç¤¾ã®WordPressæ›´æ–°ã‚’é–‹å§‹"
          echo "=========================================="
          python scripts/4_wordpress_smart_update.py --update-only
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¯¾è±¡:** æ—¢å­˜100ç¤¾ã®ã¿æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.prepare-csv.outputs.csv_found }}" == "true" ]; then
            echo "âœ… CSVæº–å‚™: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "âœ… WordPressæ›´æ–°: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ CSVæº–å‚™: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ æ—¢å­˜100ç¤¾ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
