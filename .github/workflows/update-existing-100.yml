name: Daily Update - Complete Workflow (Mon-Fri)

on:
  # æœˆæ›œã€œé‡‘æ›œ JST 9:00 (UTC 0:00) ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * 1-5'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:

jobs:
  complete-update:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ============================================================
      
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests yfinance
      
      # ============================================================
      # Step 1: yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—
      # ============================================================
      
      - name: Check company list
        id: check-list
        run: |
          if [ -f "data/japan_companies_latest.csv" ]; then
            echo "list_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… japan_companies_latest.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            COMPANY_COUNT=$(wc -l < data/japan_companies_latest.csv)
            echo "ğŸ“Š ä¼æ¥­æ•°: $COMPANY_COUNT"
          else
            echo "list_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ japan_companies_latest.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã§ 1_scrape_yahoo_finance.py ã‚’å®Ÿè¡Œã—ã¦ã€japan_companies_latest.csv ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"
            exit 1
          fi
      
      - name: Fetch yfinance data
        if: steps.check-list.outputs.list_exists == 'true'
        run: |
          echo "=========================================="
          echo "Step 1: yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹"
          echo "=========================================="
          python scripts/2_fetch_yfinance_data.py
      
      # ============================================================
      # Step 2: ãƒ‡ãƒ¼ã‚¿çµ±åˆ
      # ============================================================
      
      - name: Merge data
        id: merge
        run: |
          echo "=========================================="
          echo "Step 2: ãƒ‡ãƒ¼ã‚¿çµ±åˆé–‹å§‹"
          echo "=========================================="
          
          # æœ€æ–°ã®yfinance CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
          YFINANCE_CSV=$(ls -t output/yfinance_all_fields_*.csv 2>/dev/null | head -n1)
          
          if [ -z "$YFINANCE_CSV" ]; then
            echo "âŒ yfinanceãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "ğŸ“¥ ä½¿ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "   Yahoo JP: data/japan_companies_latest.csv"
          echo "   yfinance: $YFINANCE_CSV"
          
          # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          export YAHOO_JP_CSV=data/japan_companies_latest.csv
          export YFINANCE_CSV=$YFINANCE_CSV
          export OUTPUT_DIR=data
          
          # 3_merge_data.py ã‚’å®Ÿè¡Œ
          python scripts/3_merge_data.py
          
          # çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "data/integrated_company_data.csv" ]; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            INTEGRATED_COUNT=$(wc -l < data/integrated_company_data.csv)
            echo "âœ… integrated_company_data.csv ç”Ÿæˆå®Œäº†"
            echo "ğŸ“Š ä¼æ¥­æ•°: $INTEGRATED_COUNT"
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "âŒ integrated_company_data.csv ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
      
      # ============================================================
      # Step 3: WordPressæ›´æ–° (æ—¢å­˜100ç¤¾ã®ã¿)
      # ============================================================
      
      - name: Update WordPress (Existing 100 companies only)
        if: steps.merge.outputs.merge_success == 'true'
        env:
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
          REQUEST_DELAY: '0.5'
        run: |
          echo "=========================================="
          echo "Step 3: WordPressæ›´æ–°é–‹å§‹ (æ—¢å­˜100ç¤¾ã®ã¿)"
          echo "=========================================="
          python scripts/4_wordpress_smart_update.py --update-only
      
      # ============================================================
      # Artifactsä¿å­˜
      # ============================================================
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: daily-update-data
          path: |
            data/integrated_company_data*.csv
            output/yfinance_all_fields_*.csv
            output/yfinance_errors_*.csv
            output/yfinance_success_*.csv
          retention-days: 30
          if-no-files-found: warn
      
      # ============================================================
      # å®Ÿè¡Œã‚µãƒãƒªãƒ¼
      # ============================================================
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚:** $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-list.outputs.list_exists }}" == "true" ]; then
            echo "âœ… **ä¼æ¥­ãƒªã‚¹ãƒˆ:** å–å¾—æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ä¼æ¥­ãƒªã‚¹ãƒˆ:** è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.merge.outputs.merge_success }}" == "true" ]; then
            echo "âœ… **ãƒ‡ãƒ¼ã‚¿çµ±åˆ:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ‡ãƒ¼ã‚¿çµ±åˆ:** å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å‡¦ç†ãƒ•ãƒ­ãƒ¼:**" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… yfinanceãƒ‡ãƒ¼ã‚¿å–å¾—" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… ãƒ‡ãƒ¼ã‚¿çµ±åˆ (Yahoo + yfinance)" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… WordPressæ›´æ–° (æ—¢å­˜100ç¤¾)" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
