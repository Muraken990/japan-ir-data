#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
WordPressé€£æº: ç™»éŒ²æ¸ˆã¿ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
Fetch registered companies from WordPress REST API

Purpose:
- WordPress REST APIã‹ã‚‰ç™»éŒ²æ¸ˆã¿ä¼æ¥­ã‚’å–å¾—
- è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ï¼ˆTickerï¼‰ã‚’æŠ½å‡º
- CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦fetch_stock_history.pyã§ä½¿ç”¨

Author: Auto-generated by Claude Code
Date: 2025-01-04
"""

import os
import sys
import csv
import requests
import time
from datetime import datetime

# ============================================
# è¨­å®š
# ============================================

# WordPress REST APIè¨­å®š
WORDPRESS_API_URL = "https://japanir.jp/wp-json/wp/v2/company"
REQUEST_TIMEOUT = 30  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
MAX_RETRIES = 3  # ãƒªãƒˆãƒ©ã‚¤å›æ•°
MAX_PAGES = 50  # æœ€å¤§å–å¾—ãƒšãƒ¼ã‚¸æ•°ï¼ˆ100ç¤¾/ãƒšãƒ¼ã‚¸ Ã— 50 = æœ€å¤§5000ç¤¾ï¼‰

# å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(SCRIPT_DIR)
OUTPUT_FILE = os.path.join(PROJECT_ROOT, "data", "wordpress_companies.csv")

# ============================================
# WordPress REST APIã‹ã‚‰ä¼æ¥­ãƒªã‚¹ãƒˆã‚’å–å¾—
# ============================================

def fetch_wordpress_companies():
    """
    WordPress REST APIã‹ã‚‰ç™»éŒ²æ¸ˆã¿ä¼æ¥­ã‚’å–å¾—

    Returns:
        list: ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ [{code, name, ticker}, ...]
    """
    print("=" * 60)
    print("WordPressé€£æº: ç™»éŒ²æ¸ˆã¿ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—")
    print("=" * 60)
    print(f"API URL: {WORDPRESS_API_URL}")
    print()

    all_companies = []
    page = 1
    per_page = 100  # 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®å–å¾—æ•°

    while page <= MAX_PAGES:
        print(f"ğŸ“¥ ãƒšãƒ¼ã‚¸ {page}/{MAX_PAGES} ã‚’å–å¾—ä¸­...")

        params = {
            "per_page": per_page,
            "page": page,
            "_fields": "id,title,stock_code",  # å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—
            "status": "publish"  # å…¬é–‹æ¸ˆã¿ã®ã¿
        }

        # ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
        for attempt in range(1, MAX_RETRIES + 1):
            try:
                response = requests.get(
                    WORDPRESS_API_URL,
                    params=params,
                    timeout=REQUEST_TIMEOUT
                )

                if response.status_code == 200:
                    companies = response.json()

                    if not companies:
                        print(f"âœ… å…¨ãƒšãƒ¼ã‚¸å–å¾—å®Œäº†ï¼ˆãƒšãƒ¼ã‚¸ {page - 1} ã¾ã§ï¼‰")
                        return all_companies

                    # ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                    for company in companies:
                        try:
                            # stock_codeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
                            code = company.get('stock_code', '')

                            # stock_codeãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
                            if code:
                                # æ•°å­—4æ¡ã®ã¿è¨±å¯
                                if isinstance(code, str) and code.isdigit() and len(code) == 4:
                                    all_companies.append({
                                        'code': code,
                                        'name': company.get('title', {}).get('rendered', ''),
                                        'ticker': f"{code}.T"  # yfinanceå½¢å¼ã«å¤‰æ›
                                    })
                                else:
                                    print(f"  âš ï¸  ç„¡åŠ¹ãªè¨¼åˆ¸ã‚³ãƒ¼ãƒ‰: {code} (ID: {company.get('id')})")
                        except Exception as e:
                            print(f"  âŒ ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼ (ID: {company.get('id')}): {str(e)}")
                            continue

                    print(f"  âœ… {len(companies)}ä»¶å–å¾—ï¼ˆç´¯è¨ˆ: {len(all_companies)}ç¤¾ï¼‰")
                    page += 1
                    time.sleep(0.5)  # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                    break

                elif response.status_code == 400:
                    # ãƒšãƒ¼ã‚¸ç¯„å›²å¤–ï¼ˆæœ€çµ‚ãƒšãƒ¼ã‚¸åˆ°é”ï¼‰
                    print(f"âœ… å…¨ãƒšãƒ¼ã‚¸å–å¾—å®Œäº†ï¼ˆãƒšãƒ¼ã‚¸ {page - 1} ã¾ã§ï¼‰")
                    return all_companies

                else:
                    print(f"  âš ï¸  HTTPã‚¨ãƒ©ãƒ¼: {response.status_code}")
                    if attempt < MAX_RETRIES:
                        print(f"  ğŸ”„ ãƒªãƒˆãƒ©ã‚¤ {attempt}/{MAX_RETRIES}...")
                        time.sleep(2 ** attempt)  # æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
                    else:
                        print(f"  âŒ {MAX_RETRIES}å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—")
                        return all_companies

            except requests.exceptions.Timeout:
                print(f"  â±ï¸  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ")
                if attempt < MAX_RETRIES:
                    print(f"  ğŸ”„ ãƒªãƒˆãƒ©ã‚¤ {attempt}/{MAX_RETRIES}...")
                    time.sleep(2 ** attempt)
                else:
                    print(f"  âŒ {MAX_RETRIES}å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—")
                    return all_companies

            except Exception as e:
                print(f"  âŒ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {str(e)}")
                if attempt < MAX_RETRIES:
                    print(f"  ğŸ”„ ãƒªãƒˆãƒ©ã‚¤ {attempt}/{MAX_RETRIES}...")
                    time.sleep(2 ** attempt)
                else:
                    print(f"  âŒ {MAX_RETRIES}å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—")
                    return all_companies

    # æœ€å¤§ãƒšãƒ¼ã‚¸æ•°ã«åˆ°é”
    if page > MAX_PAGES:
        print()
        print(f"âš ï¸  æœ€å¤§ãƒšãƒ¼ã‚¸æ•° ({MAX_PAGES}ãƒšãƒ¼ã‚¸) ã«åˆ°é”ã—ã¾ã—ãŸ")
        print(f"ğŸ“Š å–å¾—ä¼æ¥­æ•°: {len(all_companies)}ç¤¾")

    return all_companies


def save_to_csv(companies):
    """
    ä¼æ¥­ãƒªã‚¹ãƒˆã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜

    Args:
        companies (list): ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ

    Returns:
        bool: ä¿å­˜æˆåŠŸæ™‚True
    """
    print()
    print("=" * 60)
    print("CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜")
    print("=" * 60)

    if not companies:
        print("âŒ ä¿å­˜ã™ã‚‹ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“")
        return False

    try:
        # dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=True)

        # CSVã«ä¿å­˜
        with open(OUTPUT_FILE, 'w', encoding='utf-8', newline='') as f:
            writer = csv.DictWriter(f, fieldnames=['code', 'name', 'ticker'])
            writer.writeheader()
            writer.writerows(companies)

        print(f"âœ… ä¿å­˜å®Œäº†: {OUTPUT_FILE}")
        print(f"ğŸ“Š ä¼æ¥­æ•°: {len(companies)}ç¤¾")

        # ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤ºï¼ˆæœ€åˆã®5ç¤¾ï¼‰
        print()
        print("ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®5ç¤¾ï¼‰:")
        for i, company in enumerate(companies[:5], 1):
            print(f"  {i}. {company['code']} - {company['name']} ({company['ticker']})")

        return True

    except Exception as e:
        print(f"âŒ CSVä¿å­˜ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return False


# ============================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ============================================

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    start_time = time.time()

    try:
        # WordPress APIã‹ã‚‰ä¼æ¥­ãƒªã‚¹ãƒˆå–å¾—
        companies = fetch_wordpress_companies()

        if not companies:
            print()
            print("âš ï¸  å–å¾—ã—ãŸä¼æ¥­ãŒ0ä»¶ã§ã™")
            print("åŸå› :")
            print("  - WordPress APIãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„")
            print("  - å…¬é–‹æ¸ˆã¿ä¼æ¥­æŠ•ç¨¿ãŒå­˜åœ¨ã—ãªã„")
            print("  - stock_codeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„")
            sys.exit(1)

        # é‡è¤‡ãƒã‚§ãƒƒã‚¯
        unique_codes = set()
        duplicates = []
        for company in companies:
            if company['code'] in unique_codes:
                duplicates.append(company['code'])
            unique_codes.add(company['code'])

        if duplicates:
            print()
            print(f"âš ï¸  é‡è¤‡ã™ã‚‹è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰: {', '.join(duplicates)}")

        # CSVã«ä¿å­˜
        if save_to_csv(companies):
            elapsed = time.time() - start_time
            print()
            print("=" * 60)
            print("âœ… å‡¦ç†å®Œäº†")
            print("=" * 60)
            print(f"å®Ÿè¡Œæ™‚é–“: {elapsed:.1f}ç§’")
            print(f"å–å¾—ä¼æ¥­æ•°: {len(companies)}ç¤¾")
            print(f"å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: {OUTPUT_FILE}")
            print()
            print("æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
            print("  1. fetch_stock_history.py ã‚’å®Ÿè¡Œã—ã¦æ ªä¾¡å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—")
            print("  2. GitHub Actionsã§è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹åŒ–")
            sys.exit(0)
        else:
            sys.exit(1)

    except KeyboardInterrupt:
        print()
        print("âš ï¸  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ä¸­æ–­")
        sys.exit(1)
    except Exception as e:
        print()
        print(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
